---
title: "From metawebs to regional and local"
author: "L.A.S."
output: html_document
editor_options: 
  chunk_output_type: console
---

## Setup

- **I run the analysis chunk by chunk, not the whole Rmd** 

- So I set `eval=TRUE` or `eval=FALSE` to run a particular chunk or I run it interactively 

```{r setup, eval=TRUE,echo=TRUE,message=FALSE }

if(file.exists(".RData")) load(".RData")

source("R/network_fun.r")

require(igraph)
require(dplyr)
require(stringr)
if( require(meweasmo) == FALSE)
  install_github("lsaravia/meweasmo")
if( require(multiweb) == FALSE)
  install_github("lsaravia/multiweb")

```

# Read the Antarctic Metawebs files with New Weddell from @Brose2019 (GATEWAy database)

```{r readAnt, eval=FALSE,echo=TRUE,message=FALSE }
#
dn <- list.files("Data",pattern = "^[MWP].*\\.dat$")
dn <- paste0("Data/", dn)
dn <- dn[c(2,3,1)]
ig_list <- readNetwork(dn,edgeListFormat=2)
names(ig_list) <- c("Ant_Potter","Ant_Weddell","Ant_Meta")

```


# QSS -  Modularity - SW - Analysis - Antarctic metaweb  

```{r ModularityAnalysisAnt, eval=FALSE,echo=F,message=FALSE,warning=TRUE}
#
# Select local food web - Potter Cove
#
# dtot1 <- dtot %>% dplyr::select(Prey_name,Predator_name,Network) %>% group_by(Network)
# ig_list <- lapply(group_split(dtot1), function(fw) {
#   d1 <- as.matrix(fw %>% dplyr::select(Prey_name,Predator_name))
#   g1 <- graph_from_edgelist(d1 , directed  = T)
#   simplify(g1)
# })
# names(ig_list) <- group_keys(dtot1)$Network

simulations_ER <- tibble()
websTbl <- tibble()
lapply(names(ig_list), function(fw){
    res <- compare_with_ER(ig_list[[fw]], fw,1000)
    simulations_ER <<- bind_rows(simulations_ErRen, res$sim)
    websTbl <<- bind_rows(websTbl, res$su)
})

#
# Run modularity 
#
# set.seed(123)
# modulos<-cluster_spinglass(redl)

#
# Add the modulos object to a vector  
#
# mod_by_red <- vector(mode="list", length=3)
# mod_by_red[[1]] <- modulos
rm(sim,dtot,dtot1,f)

save.image()

require(pander)
panderOptions('table.split.table',Inf)
panderOptions('table.style', 'multiline')

pandoc.table(t(websTbl %>% dplyr::select(Network,Size,Links,Connectance,PathLength,Clustering,SWness,SWnessCI,Q,zQ,Qlow,Qhigh,mTI,zTI,TIlow,TIhigh,Modularity,zMO,MOlow,MOhigh) %>% mutate_if(is.numeric, round, digits=4)))



```


# Motif Analysis - Antarctic

```{r MotifAnalysisMetaWeb, eval=FALSE,echo=F,message=T,warning=T}
#
# Motif
#
motif_ErRen <- tibble()
all_motif_freq <- tibble()

lapply(names(ig_list), function(fw){
    res <- calc_compare_motif(ig_list[[fw]], fw,1000)
    motif_ER <<- bind_rows(motif_ErRen, res$moter)
    all_motif_freq <<- bind_rows(all_motif_freq, res$fallm)
})

save.image()

require(pander)
panderOptions('table.split.table',Inf)
panderOptions('table.style', 'multiline')

motif_ER <- motif_ER %>% dplyr::select(Network, everything())

pandoc.table(t(motif_ER %>% mutate_if(is.numeric, round, digits=4)))

```

# Analisis of motif frequency change across networks !!! SEGUIR ACA !!!!!!

Pag 616 The R book

```{r MotifAnalysisMetaWebAcross, eval=FALSE,echo=F,message=T,warning=T}
require(dplyr)
#
# Build a dataframe with the relevant motifs
# 
pFM<- all_motif_freq %>% group_by(Network) %>% dplyr::select(X4:X6,X9) %>% rename(EC=X4,AC=X5,TT=X6,OM=X9) %>% mutate(Tot=sum(EC,AC,TT,OM)) %>% ungroup()

require(tidyr)

pFM1 <- pFM %>% mutate(EC=EC/Tot,AC=AC/Tot,TT=TT/Tot, OM=OM/Tot) %>% dplyr::select(Network:OM) %>%gather(motif,count,EC:OM)
levels(pFM1$Network) <- c("Potter Cove","Weddell Sea","Meta-web")
require(ggplot2)
gP1 <- ggplot(pFM1,aes(x=Network,y=count,fill=motif)) + geom_bar(stat="identity") + 
  scale_fill_brewer(palette = "RdYlGn", breaks=c("EC","AC","TT","OM"), name="", labels=c("Exploitative\ncompetition", "Apparent\ncompetition", "Tri-trophic\nchain","Omnivory")) + 
  xlab("") + ylab("Proportion") + theme_bw() + theme(legend.position="bottom")
#ggsave("Figures/MotifProportionByNetwork.png",width=6,height=6,units="in",dpi=600)

#
# Test it using poisson glm (only the interaction counts )
#
pFM1 <- pFM %>%  dplyr::select(Network:OM) %>%gather(motif,count,EC:OM)

model1 <- glm(count~Network*motif,poisson, data=pFM1)
summary(model1)
model2 <- glm(count~Network+motif,poisson, data=pFM1)

anova(model1,model2,test="Chi")

#
# Pearson Chi-squared independence 
#

x <- all_motif_freq %>% dplyr::select(X4:X6,X9) %>% rename(EC=X4,AC=X5,TT=X6,OM=X9)
x <- as.matrix(x)
rownames(x) <- c("Potter Cove","Weddell Sea","Meta-web")
require(RColorBrewer)
colnet <- brewer.pal(11,"RdYlGn")[c(1,11)]
#png("Figures/NetworkByMotifFreq.png",width=6,height=6,units="in",res=600)
par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(2, 2, 0, 2))
colnames(x) <- c("Exploitative\ncompetition", "Apparent\ncompetition", "Tri-trophic\nchain","Omnivory")
assocplot(t(x),col=colnet)
#dev.off()
#require(vcd)
#assoc(x, main = "Relation Network and motif", shade = TRUE)

chisq.test(x,simulate.p.value = T, B=10000)
# spineplot(x)

#         Pearson's Chi-squared test with simulated p-value (based on 10000
#         replicates)
# 
# data:  x
# X-squared = 8449.1, df = NA, p-value = 9.999e-05

```
 
# Topological Roles


@Kortsch2015

The role is described by two parameters: (i) the standardized within-module degree z and (ii) the among-module
connectivity participation coefficient PC. The z-score reflects how well a species is connected to other species inside the module relative to other species within its own module. The PC parameter estimates the distribution of a speciesâ€™ connections across the modules.


```{r topologicalRoles, eval=FALSE,echo=F,message=FALSE,warning=T}

source("R/network_fun.r")

require(igraph)
require(dplyr)
require(stringr)

#
# Motif
#
if( length(mod_by_red) == 0) {
  set.seed(123)
  mod_by_red <- vector(mode="list", length=length(ig_list))
  require(future.apply)
  plan(multiprocess)
  future_lapply( seq_len(length(ig_list)), function(i){
    modulos<-cluster_spinglass(ig_list[[i]])
    mod_by_red[[i]] <<- modulos
  })
  plan(sequential)
}

#
# Add the modulos object to a vector  
#
# mod_by_red[[1]] <- modulos
topo_roles <- tibble()
hub_conn <- tibble()

lapply(names(ig_list), function(fw){
    topo_roles <<- bind_rows(topo_roles,incremental_topoRoles(ig_list[[fw]], fw))
    i <- which( names(ig_list)==fw)
    hub_conn <<- bind_rows(hub_conn, plot_topological_roles(filter(topo_roles,Network==fw),ig_list[[fw]],mod_by_red[[i]]) %>% mutate(Network=fw))

})

save.image()

```


# Topological Roles proportions test and plot

```{r topologicalRolesTestPlot, eval=FALSE,echo=F,message=T,warning=T}

#
#
names(hub_conn)

tbl <- table(hub_conn$Network,hub_conn$type)

tbl1 <- tbl[c(1,3,2),] 

chisq.test(tbl,simulate.p.value = TRUE, B=10000)


require(ggplot2)
require(scales)
df1 <- data.frame(tbl1)
names(df1) <- c("Network","Rol","count")
df1 <- filter(df1,count!=0)
df1 <- df1 %>% group_by(Network) %>% mutate(total=sum(count),Freq=count/total)
levels(df1$Network) <- c("Meta-web","Weddell Sea","Potter Cove")


gP2 <- ggplot(df1,aes(x=forcats::fct_relevel(Network, "Potter Cove","Weddell Sea"),y=Freq,fill=Rol)) + geom_bar(stat="identity") + 
  scale_fill_brewer(palette = "RdYlGn",name="") + 
  xlab("") + ylab("") + theme_bw() + theme(legend.position="bottom")
#ggsave("Figures/TopoRolesProportionByNetwork.png",width=6,height=6,units="in",dpi=600)


# Plot motif frequency 
# 
#
pFM<- all_motif_freq %>% group_by(Network) %>% dplyr::select(X4:X6,X9) %>% rename(EC=X4,AC=X5,TT=X6,OM=X9) %>% mutate(Tot=sum(EC,AC,TT,OM)) %>% ungroup()
require(tidyr)
pFM1 <- pFM %>% mutate(EC=EC/Tot,AC=AC/Tot,TT=TT/Tot, OM=OM/Tot) %>% dplyr::select(Network:OM) %>%gather(motif,count,EC:OM)
pFM1$Network <- factor(pFM1$Network)
levels(pFM1$Network) <- c("Meta-web","Potter Cove","Weddell Sea")
forcats::fct_relevel()
require(ggplot2)
gP1 <- ggplot(pFM1,aes(x=forcats::fct_relevel(Network, "Potter Cove","Weddell Sea"),y=count,fill=motif)) + geom_bar(stat="identity") + 
  scale_fill_brewer(palette = "RdYlGn", breaks=c("EC","AC","TT","OM"), name="", labels=c("Exploitative\ncompetition", "Apparent\ncompetition", "Tri-trophic\nchain","Omnivo-\nry")) + 
  xlab("") + ylab("Proportion") + theme_bw() + theme(legend.position="bottom")



gP1 <- gP1 +  theme(legend.key.width = unit(.5, "cm"))
gP2 <- gP2 +  theme(legend.key.width = unit(.5, "cm"))

require(cowplot)
gP3 <- plot_grid(gP1,gP2,labels = c("A","B"),align = "h")
save_plot("Figures/PropMotif_Roles_ByNetwork.png",gP3,base_width=8,base_height=5,dpi=600)
#ggsave("Figures/PropMotif_Roles_ByNetwork.png",width=8,height=5,units="in",dpi=600)


#
#   Plot of topological roles with confidence interval
#

require(ggplot2)

topo_roles$Network <- factor(topo_roles$Network, levels = c("Ant_Potter","Ant_Weddell","Ant_Meta")) 
levels(topo_roles$Network)= c("Potter Cove","Weddell Sea","Meta-web")

g <- ggplot(topo_roles, aes(x=among_module_conn,y=within_module_degree,colour=Network),shape=21) +  theme_bw() + geom_point()+ 
	geom_errorbar(aes(ymin=wtmLowCI, ymax=wtmHiCI),width=0.0,alpha=0.5) +
  geom_errorbarh(aes(xmin = amcLowCI, xmax = amcHiCI),height=0.0,alpha=0.5) + 
  ylab("Within module degree") + xlab("Among module connectivity") +
	scale_colour_brewer(palette="Dark2",name="Network") + theme(legend.position="none") +  theme(axis.text.x = element_text(angle = 90, hjust = 0))

g + geom_hline(aes(yintercept=2.5),linetype = 2) + geom_vline(aes(xintercept=0.625),linetype = 2) +facet_wrap( ~Network)

ggsave("Figures/TopoRolesCI_ByNetwork.png",width=7,height=5,units="in",dpi=600)

#
# Add network area to the table with network info
# 
websTbl$Area <- c(6.8,3.5e6,34.8e6)

```

# Integrated plot of topological roles, trophic level and modularity

```{r plotTopoRolesTLmod, eval=FALSE,echo=F,message=T,warning=T}

# Read data and trim species names to avoid duplicates 
#
# dtot <- read.delim("Data/FoodwebsFixed.dat", quote="",stringsAsFactors = F)
# dtot <- dtot %>% mutate(Predator_name=str_trim(Predator_name), Prey_name=str_trim(Prey_name))

# Data frame hub_conn have the topological roles of species by network
#

# mod_by_red have the modules
#
# Correct hub_conn if it has more nodes
if ( sum(websTbl$Size)!= nrow(hub_conn) ) {

  hub_conn <- hub_conn %>% filter(!grepl("#",name)) 

}

# 
# Local 
#
png("Figures/AllTopoRoles_TL_MOD.png",width=8,height=8,units="in",res=600)
par(mfcol=c(2,2), mar=c(1,1.2,0.5,0.5), oma=c(2,2,2,0))

#plotTopoRolesByTLByMod(dtot,"Potter", "",mod_by_red[[1]],hub_conn)

plotTopoRolesByTLByMod("Ant_Potter",c("Detritus","Necromass"),mod_by_red[[1]],topoFrame=hub_conn,redl=ig_list[["Ant_Potter"]])
mtext("A", side = 3, adj = 0.05, line=1 ,cex=1.2)

#
# Metaweb
#
plotTopoRolesByTLByMod(netName ="Ant_Meta",c("Detritus","Necromass"),mod_by_red[[3]],topoFrame= hub_conn,redl=ig_list[["Ant_Meta"]])
mtext("C", side = 3, adj = 0.05, line = 0,cex=1.2)

#
# Regional 
#
plotTopoRolesByTLByMod(netName ="Ant_Weddell", "",mod_by_red[[2]],topoFrame= hub_conn,redl=ig_list[["Ant_Weddell"]])
mtext("B", side = 3, adj = 0.05, line=1,cex=1.2)

require(RColorBrewer)
colnet <- brewer.pal(4,"Paired")

plot(1, type = "n", axes=FALSE, xlab="", ylab="")
legend(x = "center",
        legend = c("Hub connectors", "Module Connectors", "Module Hubs", "Module Specialists"), 
        col=colnet,pch=19, cex=1.2)
mtext("Modules", side = 1, outer=T, line=0.1,cex=1.2,font=2)
mtext("Trophic level", side = 2, outer=T, line=0.5,cex=1.2,font=2)


dev.off()


```

# Generate datafrane with topological roles species names trophic level and degree 

```{r checkTopoRolesTLmod, eval=FALSE,echo=F,message=T,warning=T}
require(dplyr)

tRD <- tibble()
lapply(names(ig_list), function(fw){
    tRD <<-  bind_rows(tRD, getTopoRolesTLdegree(ig_list[[fw]], fw, hub_conn))
})
# tRD <- getTopoRolesTLdegree(dtot,"Potter",c("Fresh detritus","Aged detritus","Necromass"),hub_conn)
# tRD <- bind_rows(tRD, getTopoRolesTLdegree(dtot,"Weddell",c("Detritus","Necromass"),hub_conn))
# tRD <- bind_rows(tRD, getTopoRolesTLdegree(dtot,"Meta",c("Detritus","Necromass"),hub_conn))

topoRolesDegree <- tRD

topoRolesDegree %>% group_by(Network,type) %>% summarise(n=n())

# Generate table of more connected topological roles
#
require(pander)
panderOptions('table.split.table',Inf)
panderOptions('table.style', 'multiline')

# Change names of networks
topoRolesDegree$Network <- factor(topoRolesDegree$Network, levels=c("Ant_Potter", "Ant_Weddell","Ant_Meta"))
levels(topoRolesDegree$Network) <- c("Potter","Weddell","Meta-web")

pandoc.table(topoRolesDegree %>% filter(type=="hubcon" | type=="modhub" ) %>% arrange(type,Network,trophLevel) %>%  dplyr::select(type,Network,name,preys,predators,trophLevel) %>% mutate_if(is.numeric, round, digits=2))

# 
#

topoRolesDegree %>% mutate(basal=(round(trophLevel,2)<=1)) %>% group_by(type,Network,basal) %>% summarise(n=n())

rm(tRD)

save.image()

```


## Read the Islands data set and make topological analysis

```{r readIslands, eval=TRUE,echo=TRUE,message=FALSE }

require(readr)

#
# Extract Weddell Sea from GATEWAy database
#
ga <- readr::read_csv("~/Dropbox/Projects/MetaWebsAssembly/Data/283_2_FoodWebDataBase_2018_12_10.csv",col_types = "icccccccccccccddddddccccccccddddddcddccddciicc")

fw_name <- ga %>% filter(grepl("Piechnik",link.citation )) %>% distinct(foodweb.name)                
Have_df <- ga %>% filter(grepl("Piechnik",link.citation )) %>% dplyr::select(con.taxonomy,con.taxonomy.level,res.taxonomy,res.taxonomy,foodweb.name)
require(igraph)
dtot1 <- as.matrix(Have_df %>% dplyr::select(res.taxonomy,con.taxonomy))
have1  <- graph_from_edgelist(dtot1, directed  = T)

df_list <- Have_df %>% group_split(foodweb.name)
ig_list <- lapply(df_list, function(fw) {
  d1 <- as.matrix(fw %>% dplyr::select(res.taxonomy,con.taxonomy))
  graph_from_edgelist(d1, directed  = T)
})
names(ig_list) <- paste0("Isl_",fw_name$foodweb.name)
ig_list <- c(ig_list, list(Isl_Meta=have1))

```


# QSS -  Modularity - SW - Analysis - Florida Islands metaweb  

```{r qssIslands, eval=FALSE,echo=TRUE,message=FALSE }

lapply(names(ig_list), function(fw){
    res <- compare_with_ER(ig_list[[fw]], fw,1000)
    simulations_ER <<- bind_rows(simulations_ER, res$sim)
    websTbl <<- bind_rows(websTbl, res$su)
})

rm(sim,dtot,dtot1,f,ga,have1,Have_df)

save.image()

require(pander)
panderOptions('table.split.table',Inf)
panderOptions('table.style', 'multiline')

pandoc.table(t(websTbl %>% filter(grepl("Isl_", Network)) %>%
                                  dplyr::select(Network,Size,Links,Connectance,PathLength,Clustering,SWness,SWnessCI,Q,zQ,Qlow,Qhigh,mTI,zTI,TIlow,TIhigh,Modularity,zMO,MOlow,MOhigh) %>% mutate_if(is.numeric, round, digits=4)))



```


# Motif Analysis - Florida Islands

```{r MotifIslands, eval=FALSE,echo=F,message=T,warning=T}
#
# Motif
#

lapply(names(ig_list), function(fw){
    res <- calc_compare_motif(ig_list[[fw]], fw,1000)
    motif_ER <<- bind_rows(motif_ER, res$moter)
    all_motif_freq <<- bind_rows(all_motif_freq, res$fallm)
})

save.image()

require(pander)
panderOptions('table.split.table',Inf)
panderOptions('table.style', 'multiline')

motif_ER <- motif_ER %>% dplyr::select(Network, everything())

save.image()

pandoc.table(t(motif_ER %>% filter(grepl("Isl_", Network)) %>% mutate_if(is.numeric, round, digits=4)))

#
# Build a dataframe with the relevant motifs
# 
pFM<- all_motif_freq %>% filter(grepl("Isl_", Network)) %>% group_by(Network) %>% dplyr::select(X4:X6,X9) %>% rename(EC=X4,AC=X5,TT=X6,OM=X9) %>% mutate(Tot=sum(EC,AC,TT,OM)) %>% ungroup()

require(tidyr)

pFM1 <- pFM %>% mutate(EC=EC/Tot,AC=AC/Tot,TT=TT/Tot, OM=OM/Tot) %>% dplyr::select(Network:OM) %>%gather(motif,count,EC:OM)
#levels(pFM1$Network) <- c("Potter Cove","Weddell Sea","Meta-web")
require(ggplot2)
gP1 <- ggplot(pFM1,aes(x=Network,y=count,fill=motif)) + geom_bar(stat="identity") + 
  scale_fill_brewer(palette = "RdYlGn", breaks=c("EC","AC","TT","OM"), name="", labels=c("Exploitative\ncompetition", "Apparent\ncompetition", "Tri-trophic\nchain","Omnivory")) + 
  xlab("") + ylab("Proportion") + theme_bw() + theme(legend.position="bottom")
#ggsave("Figures/MotifProportionByNetwork.png",width=6,height=6,units="in",dpi=600)


#
# Pearson Chi-squared independence 
#

x <- all_motif_freq %>% filter(grepl("Isl_", Network)) %>% dplyr::select(Network,X4:X6,X9) %>% rename(EC=X4,AC=X5,TT=X6,OM=X9)
rnames <- x$Network
x <- as.matrix(x[,2:5])
rownames(x) <- rnames
require(RColorBrewer)
colnet <- brewer.pal(11,"RdYlGn")[c(1,11)]
#png("Figures/NetworkByMotifFreq.png",width=6,height=6,units="in",res=600)
par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(2, 2, 0, 2))
colnames(x) <- c("Exploitative\ncompetition", "Apparent\ncompetition", "Tri-trophic\nchain","Omnivory")
assocplot(t(x),col=colnet)
#dev.off()

chisq.test(x,simulate.p.value = T, B=10000)

# 	Pearson's Chi-squared test with simulated p-value (based on 10000 replicates)
# 
# data:  x
# X-squared = 478.84, df = NA, p-value = 9.999e-05


```

# Islands Topological Roles

```{r IslandsTopologicalRoles, eval=TRUE,echo=F,message=FALSE,warning=T}


#
# Add the modulos object to a vector  
#
set.seed(123)
mod_by_red <- vector(mode="list", length=length(ig_list))
require(future.apply)
plan(multiprocess)
future_lapply( seq_len(length(ig_list)), function(i){
  modulos<-cluster_spinglass(ig_list[[i]])
  mod_by_red[[i]] <<- modulos
})
plan(sequential)

topo_roles$Network <- as.character(topo_roles$Network)

lapply(names(ig_list), function(fw){
    topo_roles <<- bind_rows(topo_roles,incremental_topoRoles(ig_list[[fw]], fw))
    i <- which( names(ig_list)==fw)
    hub_conn <<- bind_rows(hub_conn, plot_topological_roles(filter(topo_roles,Network==fw),ig_list[[fw]],mod_by_red[[i]]) %>% mutate(Network=fw))

})

save.image()

```

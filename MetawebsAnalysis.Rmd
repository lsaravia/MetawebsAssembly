---
title: "From metawebs to regional and local"
author: "L.A.S."
output: html_document
---

## Setup

```{r setup, eval=T,echo=FALSE }
load(".RData")
oldcd <-getwd()



```


# Modularity Analysis - Local  

```{r ModularityAnalysisLocal, eval=T,echo=F,message=T,warning=T}

source("R/network_fun.r")

require(igraph)
require(dplyr)
require(stringr)

#
# Read data and trim species names to avoid duplicates 
#
dtot <- read.delim("Data/Foodwebs.dat", quote="",stringsAsFactors = F)
dtot <- dtot %>% mutate(Predator_name=str_trim(Predator_name), Prey_name=str_trim(Prey_name))

#
# Select local food web - Potter Cove
#
dtot1 <- as.matrix(dtot %>% filter(Network=="Local") %>% dplyr::select(Prey_name,Predator_name))
redl <- graph_from_edgelist(dtot1, directed  = T)

#
# Make short names 
#
require(vegan)
spnames <- make.cepnames(V(redl)$name)
#write.csv(V(redl)$name,"Local.csv")

# Test if there are duplicated species
#
V(redl)$name[grep(".1",spnames)]


#
# Run modularity 
#
set.seed(123)
modulos<-cluster_spinglass(redl)
websTbl <- calc_topological_indices(redl)  %>% mutate(Network="Local",Groups=length(modulos$csize),Modularity=modulos$modularity)

#
# Add the modulos object to a vector  
#
mod_by_red <- vector(mode="list", length=3)
mod_by_red[[1]] <- modulos

#
# Compare with random networks
#
tbl <- data.frame()
tbl <- calc_modularity_random(redl,1000)
#saveRDS(tbl,"tbl.rds")
#tbl <- readRDS("tbl.rds")
websTbl <- websTbl %>% bind_cols(tbl)

# Check for detritos
# 
grep("detr", V(redl)$name, ignore.case = TRUE, value=TRUE  )
grep("necr", V(redl)$name, ignore.case = TRUE, value=TRUE  )

#
# Calculate Trophic Position
#
require(NetIndices)
troph.net2<-TrophInd(get.adjacency(redl,sparse=F),Dead=c("Fresh detritus","Aged detritus","Necromass"))
layout.matrix.1<-matrix(
  nrow=length(V(redl)),  # Rows equal to the number of vertices
  ncol=2
)


#
# Calc incoherence
#
q <- calc_incoherence(redl,troph.net2)
websTbl$Q[1] <- q$Q
websTbl$rQ[1] <- q$rQ  # ratio of Q/eQ expected coherence under null -  Significant coherence rQ< 1, Significant incoherence rQ>1
websTbl$mTI[1] <- q$mTI # mean trophic level 
websTbl$rTI[1] <- q$rTI   # ratio of mTI/eTI expected under null 

# Calc incoherence z-score based in random E-R networks with the condition of at least one basal node
#
#
zq <- calc_incoherence_z(redl,troph.net2)
websTbl$rndQ[1] <- zq$rndQ
websTbl$rndTI[1] <- zq$rndTI
websTbl$Qlow[1] <- zq$Qlow
websTbl$Qhigh[1] <- zq$Qhigh
websTbl$TIlow[1] <- zq$TIlow
websTbl$TIhigh[1] <- zq$TIhigh
websTbl$zQ[1] <- zq$zQ
websTbl$zTI[1] <- zq$zTI


# Plot the red
# 
# Add colors to nodes 
#
require(RColorBrewer)

colTL <-as.numeric(cut(troph.net2$TL,11))
colnet <- brewer.pal(11,"RdYlGn")
V(redl)$color <- colnet[12-colTL]

#
# Plot modules
#
layout.matrix.1[,2]<-jitter(troph.net2$TL,0.4) # y-axis value based on trophic level
layout.matrix.1[,1]<-jitter(modulos$membership,1) # randomly assign along x-axis

png("Figures/LocalFoodWeb.png",width=6,height=6,units="in",res=600)
par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0))

plot(redl, vertex.color=vertex_attr(redl)$cor,vertex.label=NA,
     vertex.size=log(3*igraph::degree(redl)),
     edge.width=.3,edge.arrow.size=.4, 
     edge.color="grey50",
     edge.curved=0.3, layout=layout.matrix.1)

dev.off()
save.image()
```

# Modularity Analysis - Regional

```{r ModularityAnalysisRegional, eval=T,echo=F,message=T,warning=T}

source("R/network_fun.r")

require(igraph)
require(dplyr)
require(stringr)

#
# Read data and trim species names to avoid duplicates 
#
dtot <- read.delim("Data/Foodwebs.dat", quote="",stringsAsFactors = F)
dtot <- dtot %>% mutate(Predator_name=str_trim(Predator_name), Prey_name=str_trim(Prey_name))

#
# Select food web 
#
dtot1 <- as.matrix(dtot %>% filter(Network=="Regional") %>% dplyr::select(Prey_name,Predator_name))
redl <- graph_from_edgelist(dtot1, directed  = T)
redl <- simplify(redl)

#
# Make short names 
#
require(vegan)
spnames <- make.cepnames(V(redl)$name)
#write.csv(V(redl)$name,"Regional.csv")

# Test if there are duplicated species
#
V(redl)$name[grep(".1",spnames)]

V(redl)$name[which_loop(redl)]

#
# Run modularity 
#
set.seed(123)
modulos<-cluster_spinglass(redl)
websTbl1 <- calc_topological_indices(redl)  %>% mutate(Network="Regional",Groups=length(modulos$csize),Modularity=modulos$modularity)

#
# Add the modulos object to a vector  
#
mod_by_red[[2]] <- modulos

#
# Compare with random networks
#
tbl <- data.frame()
tbl <- calc_modularity_random(redl,1000)
#saveRDS(tbl,"tbl.rds")
#tbl <- readRDS("tbl.rds")
websTbl1 <- websTbl1 %>% bind_cols(tbl)
websTbl <- bind_rows(websTbl,websTbl1)

rm(websTbl1)

# Check for detritos
# 
grep("detr", V(redl)$name, ignore.case = TRUE, value=TRUE  )
grep("necr", V(redl)$name, ignore.case = TRUE, value=TRUE  )

#
# Calculate Trophic Position
#
require(NetIndices)
troph.net2<-TrophInd(get.adjacency(redl,sparse=F),Dead=c("Detritus","Necromass"))
layout.matrix.1<-matrix(
  nrow=length(V(redl)),  # Rows equal to the number of vertices
  ncol=2
)

#
# Calc incoherence
#
q <- calc_incoherence(redl,troph.net2)
websTbl$Q[2] <- q$Q
websTbl$rQ[2] <- q$rQ  # ratio of Q/eQ expected coherence under null -  Significan coherence rQ< 1, Significant incoherence rQ>1
websTbl$mTI[2] <- q$mTI # mean trophic level 
websTbl$rTI[2] <- q$rTI   # ratio of mTI/eTI expected under null 

#
# Calc incoherence z-score based in random E-R networks with the condition of at least one basal node
#
zq <- calc_incoherence_z(redl,troph.net2)
websTbl$rndQ[2] <- zq$rndQ
websTbl$rndTI[2] <- zq$rndTI
websTbl$Qlow[2] <- zq$Qlow
websTbl$Qhigh[2] <- zq$Qhigh
websTbl$TIlow[2] <- zq$TIlow
websTbl$TIhigh[2] <- zq$TIhigh
websTbl$zQ[2] <- zq$zQ
websTbl$zTI[2] <- zq$zTI




# 
# Add colors to nodes 
#
require(RColorBrewer)

colTL <-as.numeric(cut(troph.net2$TL,11))
colnet <- brewer.pal(11,"RdYlGn")
V(redl)$color <- colnet[12-colTL]

#
# Plot modules
#
layout.matrix.1[,2]<-jitter(troph.net2$TL,0.4) # y-axis value based on trophic level
layout.matrix.1[,1]<-jitter(modulos$membership,1) # randomly assign along x-axis

png("Figures/RegionalFoodWeb.png",width=6,height=6,units="in",res=600)
par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0))

plot(redl, vertex.color=vertex_attr(redl)$cor,vertex.label=NA,
     vertex.size=log(3*igraph::degree(redl)),
     edge.width=.3,edge.arrow.size=.4, 
     edge.color="grey50",
     edge.curved=0.3, layout=layout.matrix.1)

dev.off()
save.image()

```


# Modularity Analysis - MetaWEB!

```{r ModularityAnalysisMetaWeb, eval=T,echo=F,message=T,warning=T}

source("R/network_fun.r")

require(igraph)
require(dplyr)
require(stringr)

#
# Read data and trim species names to avoid duplicates 
#
dtot <- read.delim("Data/Foodwebs.dat", quote="",stringsAsFactors = F)
dtot <- dtot %>% mutate(Predator_name=str_trim(Predator_name), Prey_name=str_trim(Prey_name))

#
# Select food web 
#
dtot1 <- as.matrix(dtot %>% filter(Network=="Meta") %>% dplyr::select(Prey_name,Predator_name))
redl <- graph_from_edgelist(dtot1, directed  = T)

# Select only a connected subgraph graph 
V(redl)$comp <- components(redl)$membership
redm <- induced_subgraph(redl,V(redl)$comp==1)

# Unconnected components 
redd <- induced_subgraph(redl,V(redl)$comp==2)

# Delete cannibalistic 
redl <- simplify(redm)

#
# Make short names 
#
require(vegan)
spnames <- make.cepnames(V(redl)$name)
#write.csv(V(redl)$name,"Meta.csv")


# Test if there are duplicated species
#
V(redl)$name[grep(".1",spnames)]

#
# Run modularity 
#
set.seed(123)
modulos<-cluster_spinglass(redl)
websTbl1 <- calc_topological_indices(redl)  %>% mutate(Network="Meta",Groups=length(modulos$csize),Modularity=modulos$modularity)

#
# Add the modulos object to a vector  
#
mod_by_red[[3]] <- modulos

# Print species by module
#
# for( i in 1:length(modulos$csize)){
#   if(modulos$csize[i]<10){
#     cat("Group",i, "\n")
#     print(degree(redl,V(redl)[modulos$membership==i]))
#   }
# }

#
# Compare with random networks
#
tbl <- data.frame()
tbl <- calc_modularity_random(redl,1000)
#saveRDS(tbl,"tbl.rds")
#tbl <- readRDS("tbl.rds")
websTbl1 <- websTbl1 %>% bind_cols(tbl)

websTbl <- bind_rows(websTbl,websTbl1)

rm(websTbl1)


#
# Calculate Trophic Position
#
V(redl)$name[grep("Detritus",spnames)]
V(redl)[V(redl)$name=="Necromass"]

require(NetIndices)
troph.net2<-TrophInd(get.adjacency(redl,sparse=F),Dead=c("Detritus","Necromass"))
layout.matrix.1<-matrix(
  nrow=length(V(redl)),  # Rows equal to the number of vertices
  ncol=2
)

#
# Calc incoherence
#
q <- calc_incoherence(redl,troph.net2)
websTbl$Q[3] <- q$Q
websTbl$rQ[3] <- q$rQ  # ratio of Q/eQ expected coherence under null -  Significan coherence rQ< 1, Significant incoherence rQ>1
websTbl$mTI[3] <- q$mTI # mean trophic level 
websTbl$rTI[3] <- q$rTI   # ratio of mTI/eTI expected under null 


#
# Calc incoherence z-score based in random E-R networks with the condition of at least one basal node
#
zq <- calc_incoherence_z(redl,troph.net2)
websTbl$rndQ[3] <- zq$rndQ
websTbl$rndTI[3] <- zq$rndTI
websTbl$Qlow[3] <- zq$Qlow
websTbl$Qhigh[3] <- zq$Qhigh
websTbl$TIlow[3] <- zq$TIlow
websTbl$TIhigh[3] <- zq$TIhigh
websTbl$zQ[3] <- zq$zQ
websTbl$zTI[3] <- zq$zTI


# 
# Add colors to nodes 
#
require(RColorBrewer)

colTL <-as.numeric(cut(troph.net2$TL,11))
colnet <- brewer.pal(11,"RdYlGn")
V(redl)$color <- colnet[12-colTL]

#
# Plot modules
#
layout.matrix.1[,2]<-jitter(troph.net2$TL,0.4) # y-axis value based on trophic level
layout.matrix.1[,1]<-jitter(modulos$membership,1) # randomly assign along x-axis

png("Figures/MetaFoodWeb.png",width=6,height=6,units="in",res=600)
par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0))

plot(redl, vertex.color=vertex_attr(redl)$cor,vertex.label=NA,
     vertex.size=log(3*igraph::degree(redl)),
     edge.width=.3,edge.arrow.size=.4, 
     edge.color="grey50",
     edge.curved=0.3, layout=layout.matrix.1)

dev.off()

save.image()

#
# Calculate z-score of modularity
#
websTbl <- websTbl %>% mutate(zMO= (Modularity- rndMO)/(MOhigh-MOlow)*2, zGR=(Groups-rndGR)/(GRhigh-GRlow)*2)


require(pander)
panderOptions('table.split.table',Inf)
panderOptions('table.style', 'multiline')

pandoc.table(t(websTbl %>% dplyr::select(Network,Size,Links,Connectance,PathLength,Clustering,Modularity,Groups,SWness,SWnessCI,zMO,zGR,Q,rQ,mTI,rTI) %>% mutate_if(is.numeric, round, digits=4)))


```

# Analysis of motif - Local

```{r motifAnalysisLocal, eval=T,echo=F,message=T,warning=T}

source("R/network_fun.r")

require(igraph)
require(dplyr)
require(stringr)

#
# Read data and trim species names to avoid duplicates 
#
dtot <- read.delim("Data/Foodwebs.dat", quote="",stringsAsFactors = F)
dtot <- dtot %>% mutate(Predator_name=str_trim(Predator_name), Prey_name=str_trim(Prey_name))

#
# Select local food web - Potter Cove
#
dtot1 <- as.matrix(dtot %>% filter(Network=="Local") %>% dplyr::select(Prey_name,Predator_name))
redl <- graph_from_edgelist(dtot1, directed  = T)

#
# Make short names 
#
require(vegan)
spnames <- make.cepnames(V(redl)$name)
#write.csv(V(redl)$name,"Local.csv")

# Test if there are duplicated species
#
V(redl)$name[grep(".1",spnames)]

#
# Motif
#
mot <- triad_census(redl)

mot[4] # Exploitative competition
mot[5] # Apparent competition
mot[6] # Tri-trophic chain
mot[9] # Omnivory

FreqMotif <- data.frame(Network="Local",t(mot))

set.seed(123)
motif <- calc_motif_random(redl)
motif <- motif %>% mutate(Network="Local")

save.image()
```

# Analysis of motif - Regional

```{r motifAnalysisRegional, eval=T,echo=F,message=T,warning=T}

source("R/network_fun.r")

require(igraph)
require(dplyr)
require(stringr)

#
# Read data and trim species names to avoid duplicates 
#
dtot <- read.delim("Data/Foodwebs.dat", quote="",stringsAsFactors = F)
dtot <- dtot %>% mutate(Predator_name=str_trim(Predator_name), Prey_name=str_trim(Prey_name))

#
# Select food web 
#
dtot1 <- as.matrix(dtot %>% filter(Network=="Regional") %>% dplyr::select(Prey_name,Predator_name))
redl <- graph_from_edgelist(dtot1, directed  = T)
redl <- simplify(redl)

#
# Make short names 
#
require(vegan)
spnames <- make.cepnames(V(redl)$name)
#write.csv(V(redl)$name,"Regional.csv")

# Test if there are duplicated species
#
V(redl)$name[grep(".1",spnames)]
dup <- str_sub(spnames[grep(".1",spnames)], start = 1, end = -3)
V(redl)$name[str_detect(spnames,dup[1])]
V(redl)$name[str_detect(spnames,dup[2])]
V(redl)$name[str_detect(spnames,dup[3])]

V(redl)$name[which_loop(redl)]


#
# Motif
#
mot <- triad_census(redl)
mot[4] # Exploitative competition
mot[5] # Apparent competition
mot[6] # Tri-trophic chain
mot[9] # Omnivory


FreqMotif <- rbind(FreqMotif,data.frame(Network="Regional",t(mot)))

mot[10] # Loop 

set.seed(123)
motif <- bind_rows(motif, calc_motif_random(redl) %>% mutate(Network="Regional"))

save.image()
```


# Motif Analysis - MetaWEB!

```{r MotifAnalysisMetaWeb, eval=T,echo=F,message=T,warning=T}

source("R/network_fun.r")

require(igraph)
require(dplyr)
require(stringr)

#
# Read data and trim species names to avoid duplicates 
#
dtot <- read.delim("Data/Foodwebs.dat", quote="",stringsAsFactors = F)
dtot <- dtot %>% mutate(Predator_name=str_trim(Predator_name), Prey_name=str_trim(Prey_name))

#
# Select food web 
#
dtot1 <- as.matrix(dtot %>% filter(Network=="Meta") %>% dplyr::select(Prey_name,Predator_name))
redl <- graph_from_edgelist(dtot1, directed  = T)

# Select only a connected subgraph graph 
V(redl)$comp <- components(redl)$membership
redm <- induced_subgraph(redl,V(redl)$comp==1)

# Unconnected components 
redd <- induced_subgraph(redl,V(redl)$comp==2)

# Delete cannibalistic 
redl <- simplify(redm)

#
# Make short names 
#
require(vegan)
spnames <- make.cepnames(V(redl)$name)
#write.csv(V(redl)$name,"Meta.csv")


# Test if there are duplicated species
#
V(redl)$name[grep(".1",spnames)]
dup <- str_sub(spnames[grep(".1",spnames)], start = 1, end = -3)
for( i in 1:length(dup)){
  print(V(redl)$name[str_detect(spnames,dup[i])])
}

V(redl)$name[which_loop(redl)]


#
# Motif
#
mot <- triad_census(redl)
mot[4] # Exploitative competition
mot[5] # Apparent competition
mot[6] # Tri-trophic chain
mot[9] # Omnivory

FreqMotif <- rbind(FreqMotif,data.frame(Network="Meta",t(mot)))

mot[10] # Loop 

set.seed(123)
motif <- bind_rows(motif, calc_motif_random(redl) %>% mutate(Network="Meta"))

save.image()

require(pander)
panderOptions('table.split.table',Inf)
panderOptions('table.style', 'multiline')

motif <- motif %>% dplyr::select(Network, 1:length(names(motif)))

pandoc.table(t(motif %>% mutate_if(is.numeric, round, digits=4)))

```

# Analisis of motif frequency change across networks

Pag 616 The R book

```{r MotifAnalysisMetaWeb, eval=T,echo=F,message=T,warning=T}
require(dplyr)
#
# Build a dataframe with the relevant motifs
# 
pFM<- FreqMotif %>% group_by(Network) %>% dplyr::select(X4:X6,X9) %>% rename(EC=X4,AC=X5,TT=X6,OM=X9) %>% mutate(Tot=sum(EC,AC,TT,OM)) %>% ungroup()

require(tidyr)

pFM1 <- pFM %>% mutate(EC=EC/Tot,AC=AC/Tot,TT=TT/Tot, OM=OM/Tot) %>% dplyr::select(Network:OM) %>%gather(motif,count,EC:OM)
require(ggplot2)
ggplot(pFM1,aes(x=Network,y=count,fill=motif)) + geom_bar(stat="identity") + 
  scale_fill_brewer(palette = "RdYlGn", breaks=c("EC","AC","TT","OM"), name="", labels=c("Exploitative\ncompetition", "Apparent\ncompetition", "Tri-trophic\nchain","Omnivory")) + 
  xlab("") + ylab("Proportion") + theme_bw() + theme(legend.position="bottom")
ggsave("Figures/MotifProportionByNetwork.png",width=6,height=6,units="in",dpi=600)

#
# Test it using poisson glm (only the interaction counts )
#
pFM1 <- pFM %>%  dplyr::select(Network:OM) %>%gather(motif,count,EC:OM)

model1 <- glm(count~Network*motif,poisson, data=pFM1)
summary(model1)
model2 <- glm(count~Network+motif,poisson, data=pFM1)

anova(model1,model2,test="Chi")

#
# Pearson Chi-squared independence 
#

x <- FreqMotif %>% dplyr::select(X4:X6,X9) %>% rename(EC=X4,AC=X5,TT=X6,OM=X9)
x <- as.matrix(x)
rownames(x) <- FreqMotif$Network
require(RColorBrewer)
colnet <- brewer.pal(11,"RdYlGn")[c(1,11)]
png("Figures/NetworkByMotifFreq.png",width=6,height=6,units="in",res=600)
par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(2, 2, 0, 2))
colnames(x) <- c("Exploitative\ncompetition", "Apparent\ncompetition", "Tri-trophic\nchain","Omnivory")
assocplot(t(x),col=colnet)
dev.off()
#require(vcd)
#assoc(x, main = "Relation Network and motif", shade = TRUE)

chisq.test(x,simulate.p.value = T, B=10000)
spineplot(x)
```
 
# Topological Roles


@Kortsch2015

The role is described by two parameters: (i) the standardized within-module degree z and (ii) the among-module
connectivity participation coefficient PC. The z-score reflects how well a species is connected to other species inside the module relative to other species within its own module. The PC parameter estimates the distribution of a speciesâ€™ connections across the modules.


```{r topologicalRoles, eval=T,echo=F,message=T,warning=T}

source("R/network_fun.r")

require(igraph)
require(dplyr)
require(stringr)

#
# Read data and trim species names to avoid duplicates 
#
dtot <- read.delim("Data/Foodwebs.dat", quote="",stringsAsFactors = F)
dtot <- dtot %>% mutate(Predator_name=str_trim(Predator_name), Prey_name=str_trim(Prey_name))

#################################################
#
# Select local food web 
#
dtot1 <- as.matrix(dtot %>% filter(Network=="Local") %>% dplyr::select(Prey_name,Predator_name))
redl <- graph_from_edgelist(dtot1, directed  = T)

#
# Calc topological roles 1000 simulations
#
tR1 <- calc_topological_roles(redl)
tR  <- tR1 %>% group_by(node) %>% summarize(wtmLowCI=quantile(within_module_degree,0.005,na.rm=TRUE),
                                        wtmHiCI=quantile(within_module_degree,0.995,na.rm=TRUE),
                                        amcLowCI=quantile(among_module_conn,0.005,na.rm=TRUE),
                                        amcHiCI=quantile(among_module_conn,0.995,na.rm=TRUE),
                                        within_module_degree=mean(within_module_degree,na.rm=TRUE),
                                        among_module_conn=mean(among_module_conn,na.rm=TRUE))

topoRoles <- tR %>% mutate(Network="Local")

# Initialize hub_conn
hub_conn <- data.frame()

# Plot and clasify topological roles
hub_conn <- bind_rows(hub_conn, plot_topological_roles(filter(topoRoles,Network=="Local"),redl,mod_by_red[[1]]) %>% mutate(Network="Local"))

dev.off()

save.image()

# Check if 100 simulations are the same as 1000
#
tR1 <- calc_topological_roles(redl,100)
tR2 <- topoRoles %>% filter(Network=="Local") 
require(kSamples)
ad.test(list(tR1$among_module_conn,tR2$among_module_conn),method="simulated",nsim=1000)
ad.test(list(tR1$within_module_degree,tR2$within_module_degree),method="simulated",nsim=1000)
#
# No difference with 100 or 1000 simulations
#
require(ggplot2)
tR3 <- tR1 %>% mutate(nsim=100) %>% bind_rows(tR2 %>% mutate(nsim=1000)) %>% mutate(nsim=as.factor(nsim))
ggplot(tR3, aes(within_module_degree,fill=nsim)) + geom_density(alpha=.5)
ggplot(tR3, aes(among_module_conn,fill=nsim)) + geom_density(alpha=.5)

rm(tR1,tR2,tR3)

######################################################
#
# Select regional food web 
#
dtot1 <- as.matrix(dtot %>% filter(Network=="Regional") %>% dplyr::select(Prey_name,Predator_name))
redl <- graph_from_edgelist(dtot1, directed  = T)
redl <- simplify(redl)

# Incremental calculation of topological roles
#

tR1 <- calc_topological_roles(redl,100)
tR  <- tR1 %>% group_by(node) %>% summarize(wtmLowCI=quantile(within_module_degree,0.005,na.rm=TRUE),
                                        wtmHiCI=quantile(within_module_degree,0.995,na.rm=TRUE),
                                        amcLowCI=quantile(among_module_conn,0.005,na.rm=TRUE),
                                        amcHiCI=quantile(among_module_conn,0.995,na.rm=TRUE),
                                        within_module_degree=mean(within_module_degree,na.rm=TRUE),
                                        among_module_conn=mean(among_module_conn,na.rm=TRUE))

tR1 <- bind_rows(tR1, calc_topological_roles(redl,10))
saveRDS(tR1,"TopoRoles_Regional.rds")
tR2 <-   tR1 %>% group_by(node) %>% summarize(wtmLowCI=quantile(within_module_degree,0.005,na.rm=TRUE),
                                        wtmHiCI=quantile(within_module_degree,0.995,na.rm=TRUE),
                                        amcLowCI=quantile(among_module_conn,0.005,na.rm=TRUE),
                                        amcHiCI=quantile(among_module_conn,0.995,na.rm=TRUE),
                                        within_module_degree=mean(within_module_degree,na.rm=TRUE),
                                        among_module_conn=mean(among_module_conn,na.rm=TRUE))

# 
# There are Differences between X and X+10 simulations
#  tR  = 100 
#  tR2 = 110
#  tR1 = data.frame with added simulations

require(kSamples)
ad.test(list(tR2$among_module_conn,tR$among_module_conn),method="simulated",nsim=1000)
ad.test(list(tR2$within_module_degree,tR$within_module_degree),method="simulated",nsim=1000)

#               AD     T.AD  asympt. P-value  sim. P-value
# version 1: 1.026  0.03472           0.3433        0.3418
# version 2: 0.579 -0.55420           0.6677        0.6577

#
# Add to general dataframe TR2!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
#
#topoRoles <- topoRoles %>% filter(Network!="Regional")

topoRoles <- bind_rows(topoRoles, tR2 %>% mutate(Network="Regional"))

#
# Plot and clasify topological roles
#

hub_conn <- bind_rows(hub_conn,plot_topological_roles(filter(topoRoles,Network=="Regional"),redl,mod_by_red[[2]]) %>% mutate(Network="Regional"))

dev.off()

##############################################################
#
# Select meta food web 
#
dtot1 <- as.matrix(dtot %>% filter(Network=="Meta") %>% dplyr::select(Prey_name,Predator_name))
redl <- graph_from_edgelist(dtot1, directed  = T)
redl <- simplify(redl)

# Calc topological roles incrementally and test if there are differences 
#
rm(tR,tR1,tR2)

#
tR1 <- calc_topological_roles(redl,10)
tR  <- tR1 %>% group_by(node) %>% summarize(wtmLowCI=quantile(within_module_degree,0.005,na.rm=TRUE),
                                        wtmHiCI=quantile(within_module_degree,0.995,na.rm=TRUE),
                                        amcLowCI=quantile(among_module_conn,0.005,na.rm=TRUE),
                                        amcHiCI=quantile(among_module_conn,0.995,na.rm=TRUE),
                                        within_module_degree=mean(within_module_degree,na.rm=TRUE),
                                        among_module_conn=mean(among_module_conn,na.rm=TRUE))

#tR1 <- readRDS("TopoRoles_Meta.rds")

tR1 <- bind_rows(tR1, calc_topological_roles(redl,10))
saveRDS(tR1,"TopoRoles_Meta.rds")
tR2 <-   tR1 %>% group_by(node) %>% summarize(wtmLowCI=quantile(within_module_degree,0.005,na.rm=TRUE),
                                        wtmHiCI=quantile(within_module_degree,0.995,na.rm=TRUE),
                                        amcLowCI=quantile(among_module_conn,0.005,na.rm=TRUE),
                                        amcHiCI=quantile(among_module_conn,0.995,na.rm=TRUE),
                                        within_module_degree=mean(within_module_degree,na.rm=TRUE),
                                        among_module_conn=mean(among_module_conn,na.rm=TRUE))

#
# 
# There are Differences between X and X+10 simulations
#  tR  = 40 
#  tR2 = 50
#  tR1 = data.frame with added simulations

require(kSamples)
ad.test(list(tR2$among_module_conn,tR$among_module_conn),method="simulated",nsim=1000)
ad.test(list(tR2$within_module_degree,tR$within_module_degree),method="simulated",nsim=1000)

tR <- tR2

# At 50 sims there is no difference with 40
#
#                 AD   T.AD  asympt. P-value  sim. P-value
# version 1: 0.04612 -1.254                1             1
# version 2: 0.04160 -1.260                1             1
#
#              AD   T.AD  asympt. P-value  sim. P-value
# version 1: 2.08 1.4200          0.08299        0.0849
# version 2: 1.31 0.4092          0.22860        0.2307

topoRoles <- bind_rows(topoRoles, tR %>% mutate(Network="Meta"))

hub_conn <- bind_rows(hub_conn,plot_topological_roles(filter(topoRoles,Network=="Meta"),redl,mod_by_red[[3]]) %>% mutate(Network="Meta"))

save.image()


names(hub_conn)

tbl <- table(hub_conn$Network,hub_conn$type)

tbl1 <- tbl[c(1,3,2),] 

chisq.test(tbl,simulate.p.value = TRUE, B=10000)

require(RColorBrewer)
colnet <- brewer.pal(11,"RdYlGn")[c(1,11)]
#png("Figures/NetworkByMotifFreq.png",width=6,height=6,units="in",res=600)
par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(2, 2, 0, 2))
colnames(tbl1) <- c("Hub\nconnectors", "Module\nConnectors", "Module\nHubs", "Module\nSpecialists")
assocplot(t(tbl1),col=colnet)

require(ggplot2)
require(scales)
df1 <- data.frame(tbl1)
names(df1) <- c("Network","Rol","count")
df1 <- filter(df1,count!=0)
#df1 <- df1 %>% group_by(Network) %>% mutate(total=sum(count),Freq=count/total) 
g2 <- ggplot(df1,aes(x=Network,y=count,fill=Rol)) + geom_bar(stat="identity",position=position_dodge()) + 
  scale_fill_brewer(palette = "RdYlGn",name="Topological\nRol") + scale_y_continuous(trans=log1p_trans(),breaks=c(1,10,100,1000)) +
  xlab("") + ylab("") + theme_bw() #+ theme(legend.position="bottom") 
ggsave("Figures/TopoRolesProportionByNetwork.png",width=6,height=6,units="in",dpi=600)

# Combine g1 & g2 

require(tidyr)

names(motif)
pFM1 <- motif %>% dplyr::select(Network,zEC:zOM) %>%gather(motif,value,zEC:zOM)

g1 <- ggplot(pFM1,aes(x=Network,y=value,fill=motif)) + geom_bar(stat="identity",position=position_dodge()) + 
  scale_fill_brewer(palette = "RdYlGn",breaks=c("zEC","zAC","zTT","zOM"),name="Motif\nZ-score",   labels=c("Exploitative\ncompetition", "Apparent\ncompetition", "Tri-trophic\nchain","Omnivory")) + 
  xlab("") + ylab("") + theme_bw() + scale_x_discrete(limits=c("Local","Regional","Meta")) #+ theme(legend.position="bottom")

# Normalize z-scores
#
# pFM1 <- pFM1 %>% group_by(Network) %>% mutate(normZ=value/sum(sqrt(value^2)))
# 
# g1 <- ggplot(pFM1,aes(x=Network,y=normZ,fill=motif)) + geom_bar(stat="identity",position=position_dodge()) + 
#   scale_fill_brewer(palette = "RdYlGn",breaks=c("zEC","zAC","zTT","zOM"),name="Motif\nZ-score",   labels=c("Exploitative\ncompetition", "Apparent\ncompetition", "Tri-trophic\nchain","Omnivory")) + 
#   xlab("") + ylab("") + theme_bw() + scale_x_discrete(limits=c("Local","Regional","Meta")) #+ theme(legend.position="bottom")

g1
require(cowplot)
plot_grid(g1,g2,labels = c("A","B"),align = "h")

ggsave("Figures/Motif_TopoRoles_ByNetwork.png",width=8,height=5,units="in",dpi=600)


#
#   Plot of topological roles with confidence interval
#

require(ggplot2)

topoRoles$Network <- factor(topoRoles$Network, levels = c("Local","Regional","Meta")) 

g <- ggplot(topoRoles, aes(x=among_module_conn,y=within_module_degree,colour=Network),shape=21) +  theme_bw() + geom_point()+ 
	geom_errorbar(aes(ymin=wtmLowCI, ymax=wtmHiCI),width=0.0,alpha=0.5) +
  geom_errorbarh(aes(xmin = amcLowCI, xmax = amcHiCI),height=0.0,alpha=0.5) + 
  ylab("Within module degree") + xlab("Among module connectivity") +
	scale_colour_brewer(palette="Dark2",name="Network") + theme(legend.position="none") +  theme(axis.text.x = element_text(angle = 90, hjust = 0))

g + geom_hline(aes(yintercept=2.5),linetype = 2) + geom_vline(aes(xintercept=0.625),linetype = 2) +facet_wrap( ~Network)

ggsave("Figures/TopoRolesCI_ByNetwork.png",width=7,height=5,units="in",dpi=600)

#
# Add network area to the table with network info
# 
websTbl$Area <- c(6.8,3.5e6,34.8e6)

ggplot(websTbl,aes(log(Area),log(Size))) + geom_point() + geom_line()

#
# Calc the species area exponent
#
lm(log(websTbl$Size[2:3]) ~ log(websTbl$Area[2:3]))
lm(log(websTbl$Size[1:2]) ~ log(websTbl$Area[1:2]))
lm(log(websTbl$Size) ~ log(websTbl$Area))

exp(4.2822)*(websTbl$Area[2])^0.1193

```

# Integrated plot of topological roles, trophic level and modularity

```{r plotTopoRolesTLmod, eval=T,echo=F,message=T,warning=T}

# Data frame hub_conn have the topological roles of species by network

# mod_by_red have the modules

# 
# Local 
#
png("Figures/AllTopoRoles_TL_MOD.png",width=8,height=8,units="in",res=600)
par(mfcol=c(2,2), mar=c(1,1.2,0.5,0.5), oma=c(2,2,2,0))

plotTopoRolesByTLByMod(dtot,"Local",c("Fresh detritus","Aged detritus","Necromass"),mod_by_red[[1]],hub_conn)
mtext("A", side = 3, adj = 0.05, line=1 ,cex=1.2)

#
# Metaweb
#
plotTopoRolesByTLByMod(dtot,"Meta",c("Detritus","Necromass"),mod_by_red[[3]],hub_conn)
mtext("C", side = 3, adj = 0.05, line = 0,cex=1.2)

# modulos<-cluster_spinglass(redl)
# plotTopoRolesByTLByMod(dtot,"Meta",c("Detritus","Necromass"),modulos,hub_conn)
# mod_by_red[[3]] <- modulos

#
# Regional 
#
plotTopoRolesByTLByMod(dtot,"Regional",c("Detritus","Necromass"),mod_by_red[[2]],hub_conn)
mtext("B", side = 3, adj = 0.05, line=1,cex=1.2)


require(RColorBrewer)
colnet <- brewer.pal(4,"RdYlGn")

#par( mar=c(1,1,0.5,0.5), oma=c(2,2,2,1))


plot(1, type = "n", axes=FALSE, xlab="", ylab="")
legend(x = "center",
        legend = c("Hub connectors", "Module Connectors", "Module Hubs", "Module Specialists"), 
        col=colnet,pch=19, cex=1.2)
mtext("Modules", side = 1, outer=T, line=0.1,cex=1.2,font=2)
mtext("Trophic level", side = 2, outer=T, line=0.5,cex=1.2,font=2)


# mtext("B", side = 3, adj = 0.05, outer=F,line=-1,cex=1.2)
# mtext("B", side = 3, adj = 0.05, outer=F,line=0,cex=1.2)
# box("plot", lty="dotted", col="red")
# box("inner", lty="dotted", col="green")
# box("outer", lty="solid", col="green")

dev.off()


```

# Generate datafrane with topological roles species names trophic level and degree 

```{r checkTopoRolesTLmod, eval=T,echo=F,message=T,warning=T}
require(dplyr)
hub_conn %>% filter(type=="hubcon")

unique(hub_conn$type)

tRD <- getTopoRolesTLdegree(dtot,"Local",c("Fresh detritus","Aged detritus","Necromass"),hub_conn)
tRD <- bind_rows(tRD, getTopoRolesTLdegree(dtot,"Regional",c("Detritus","Necromass"),hub_conn))
tRD <- bind_rows(tRD, getTopoRolesTLdegree(dtot,"Meta",c("Detritus","Necromass"),hub_conn))

topoRolesDegree <- tRD
rm(tRD)
topoRolesDegree %>% group_by(type,Network) %>% summarise(n=n())

# Generate table of more connected topological roles
#
require(pander)
panderOptions('table.split.table',Inf)
panderOptions('table.style', 'multiline')

pandoc.table(topoRolesDegree %>% filter(type=="hubcon" | type=="modhub" ) %>% arrange(type,Network,trophLevel) %>%  dplyr::select(type,Network,name,preys,predators,trophLevel) %>% mutate_if(is.numeric, round, digits=2))

# 
#

topoRolesDegree %>% mutate(basal=(round(trophLevel,2)<=1)) %>% group_by(type,Network,basal) %>% summarise(n=n())

save.image()

```



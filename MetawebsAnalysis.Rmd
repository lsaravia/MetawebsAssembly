---
title: "From metawebs to regional and local"
author: "L.A.S. - T. M."
output: html_document
---

## Setup

```{r setup, eval=T,echo=FALSE }
load(".RData")
oldcd <-getwd()



```


# Modularity Analysis - Local  

```{r ModularityAnalysisLocal, eval=T,echo=F,message=T,warning=T}

source("R/network_fun.r")

require(igraph)
require(dplyr)
require(stringr)

#
# Read data and trim species names to avoid duplicates 
#
dtot <- read.delim("Data/Foodwebs.dat", quote="",stringsAsFactors = F)
dtot <- dtot %>% mutate(Predator_name=str_trim(Predator_name), Prey_name=str_trim(Prey_name))

#
# Select local food web - Potter Cove
#
dtot1 <- as.matrix(dtot %>% filter(Network=="Local") %>% dplyr::select(Prey_name,Predator_name))
redl <- graph_from_edgelist(dtot1, directed  = T)

#
# Make short names 
#
require(vegan)
spnames <- make.cepnames(V(redl)$name)
#write.csv(V(redl)$name,"Local.csv")

# Test if there are duplicated species
#
V(redl)$name[grep(".1",spnames)]


#
# Run modularity 
#
set.seed(123)
modulos<-cluster_spinglass(redl)
websTbl <- calc_topological_indices(redl)  %>% mutate(Network="Local",Groups=length(modulos$csize),Modularity=modulos$modularity)

#
# Add the modulos object to a vector  
#
mod_by_red <- vector(mode="list", length=3)
mod_by_red[[1]] <- modulos

#
# Compare with random networks
#
tbl <- data.frame()
tbl <- calc_modularity_random(redl,1000)
#saveRDS(tbl,"tbl.rds")
#tbl <- readRDS("tbl.rds")
websTbl <- websTbl %>% bind_cols(tbl)

# Check for detritos
# 
grep("detr", V(redl)$name, ignore.case = TRUE, value=TRUE  )
grep("necr", V(redl)$name, ignore.case = TRUE, value=TRUE  )

#
# Calculate Trophic Position
#
require(NetIndices)
troph.net2<-TrophInd(get.adjacency(redl,sparse=F),Dead=c("Fresh detritus","Aged detritus","Necromass"))
layout.matrix.1<-matrix(
  nrow=length(V(redl)),  # Rows equal to the number of vertices
  ncol=2
)


#
# Calc incoherence
#
q <- calc_incoherence(redl,troph.net2)
websTbl$Q[1] <- q$Q
websTbl$rQ[1] <- q$rQ  # ratio of Q/eQ expected coherence under null -  Significant coherence rQ< 1, Significant incoherence rQ>1
websTbl$mTI[1] <- q$mTI # mean trophic level 
websTbl$rTI[1] <- q$rTI   # ratio of mTI/eTI expected under null 

# Plot the red
# 
# Add colors to nodes 
#
require(RColorBrewer)

colTL <-as.numeric(cut(troph.net2$TL,11))
colnet <- brewer.pal(11,"RdYlGn")
V(redl)$color <- colnet[12-colTL]

#
# Plot modules
#
layout.matrix.1[,2]<-jitter(troph.net2$TL,0.4) # y-axis value based on trophic level
layout.matrix.1[,1]<-jitter(modulos$membership,1) # randomly assign along x-axis

png("Figures/LocalFoodWeb.png",width=6,height=6,units="in",res=600)
par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0))

plot(redl, vertex.color=vertex_attr(redl)$cor,vertex.label=NA,
     vertex.size=log(3*igraph::degree(redl)),
     edge.width=.3,edge.arrow.size=.4, 
     edge.color="grey50",
     edge.curved=0.3, layout=layout.matrix.1)

dev.off()
save.image()
```

# Modularity Analysis - Regional

```{r ModularityAnalysisRegional, eval=T,echo=F,message=T,warning=T}

source("R/network_fun.r")

require(igraph)
require(dplyr)
require(stringr)

#
# Read data and trim species names to avoid duplicates 
#
dtot <- read.delim("Data/Foodwebs.dat", quote="",stringsAsFactors = F)
dtot <- dtot %>% mutate(Predator_name=str_trim(Predator_name), Prey_name=str_trim(Prey_name))

#
# Select food web 
#
dtot1 <- as.matrix(dtot %>% filter(Network=="Regional") %>% dplyr::select(Prey_name,Predator_name))
redl <- graph_from_edgelist(dtot1, directed  = T)
redl <- simplify(redl)

#
# Make short names 
#
require(vegan)
spnames <- make.cepnames(V(redl)$name)
#write.csv(V(redl)$name,"Regional.csv")

# Test if there are duplicated species
#
V(redl)$name[grep(".1",spnames)]

V(redl)$name[which_loop(redl)]

#
# Run modularity 
#
set.seed(123)
modulos<-cluster_spinglass(redl)
websTbl1 <- calc_topological_indices(redl)  %>% mutate(Network="Regional",Groups=length(modulos$csize),Modularity=modulos$modularity)

#
# Add the modulos object to a vector  
#
mod_by_red[[2]] <- modulos

#
# Compare with random networks
#
tbl <- data.frame()
tbl <- calc_modularity_random(redl,1000)
#saveRDS(tbl,"tbl.rds")
#tbl <- readRDS("tbl.rds")
websTbl1 <- websTbl1 %>% bind_cols(tbl)
websTbl <- bind_rows(websTbl,websTbl1)

rm(websTbl1)

# Check for detritos
# 
grep("detr", V(redl)$name, ignore.case = TRUE, value=TRUE  )
grep("necr", V(redl)$name, ignore.case = TRUE, value=TRUE  )

#
# Calculate Trophic Position
#
require(NetIndices)
troph.net2<-TrophInd(get.adjacency(redl,sparse=F),Dead=c("Detritus","Necromass"))
layout.matrix.1<-matrix(
  nrow=length(V(redl)),  # Rows equal to the number of vertices
  ncol=2
)

#
# Calc incoherence
#
q <- calc_incoherence(redl,troph.net2)
websTbl$Q[2] <- q$Q
websTbl$rQ[2] <- q$rQ  # ratio of Q/eQ expected coherence under null -  Significan coherence rQ< 1, Significant incoherence rQ>1
websTbl$mTI[2] <- q$mTI # mean trophic level 
websTbl$rTI[2] <- q$rTI   # ratio of mTI/eTI expected under null 



# 
# Add colors to nodes 
#
require(RColorBrewer)

colTL <-as.numeric(cut(troph.net2$TL,11))
colnet <- brewer.pal(11,"RdYlGn")
V(redl)$color <- colnet[12-colTL]

#
# Plot modules
#
layout.matrix.1[,2]<-jitter(troph.net2$TL,0.4) # y-axis value based on trophic level
layout.matrix.1[,1]<-jitter(modulos$membership,1) # randomly assign along x-axis

png("Figures/RegionalFoodWeb.png",width=6,height=6,units="in",res=600)
par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0))

plot(redl, vertex.color=vertex_attr(redl)$cor,vertex.label=NA,
     vertex.size=log(3*igraph::degree(redl)),
     edge.width=.3,edge.arrow.size=.4, 
     edge.color="grey50",
     edge.curved=0.3, layout=layout.matrix.1)

dev.off()
save.image()

```


# Modularity Analysis - MetaWEB!

```{r ModularityAnalysisMetaWeb, eval=T,echo=F,message=T,warning=T}

source("R/network_fun.r")

require(igraph)
require(dplyr)
require(stringr)

#
# Read data and trim species names to avoid duplicates 
#
dtot <- read.delim("Data/Foodwebs.dat", quote="",stringsAsFactors = F)
dtot <- dtot %>% mutate(Predator_name=str_trim(Predator_name), Prey_name=str_trim(Prey_name))

#
# Select food web 
#
dtot1 <- as.matrix(dtot %>% filter(Network=="Meta") %>% dplyr::select(Prey_name,Predator_name))
redl <- graph_from_edgelist(dtot1, directed  = T)

# Select only a connected subgraph graph 
V(redl)$comp <- components(redl)$membership
redm <- induced_subgraph(redl,V(redl)$comp==1)

# Unconnected components 
redd <- induced_subgraph(redl,V(redl)$comp==2)

# Delete cannibalistic 
redl <- simplify(redm)

#
# Make short names 
#
require(vegan)
spnames <- make.cepnames(V(redl)$name)
#write.csv(V(redl)$name,"Meta.csv")


# Test if there are duplicated species
#
V(redl)$name[grep(".1",spnames)]

#
# Run modularity 
#
set.seed(123)
modulos<-cluster_spinglass(redl)
websTbl1 <- calc_topological_indices(redl)  %>% mutate(Network="Meta",Groups=length(modulos$csize),Modularity=modulos$modularity)

#
# Add the modulos object to a vector  
#
mod_by_red[[3]] <- modulos

# Print species by module
#
# for( i in 1:length(modulos$csize)){
#   if(modulos$csize[i]<10){
#     cat("Group",i, "\n")
#     print(degree(redl,V(redl)[modulos$membership==i]))
#   }
# }

#
# Compare with random networks
#
tbl <- data.frame()
tbl <- calc_modularity_random(redl,1000)
#saveRDS(tbl,"tbl.rds")
#tbl <- readRDS("tbl.rds")
websTbl1 <- websTbl1 %>% bind_cols(tbl)

websTbl <- bind_rows(websTbl,websTbl1)

rm(websTbl1)


#
# Calculate Trophic Position
#
V(redl)$name[grep("Detritus",spnames)]
V(redl)[V(redl)$name=="Necromass"]

require(NetIndices)
troph.net2<-TrophInd(get.adjacency(redl,sparse=F),Dead=c("Detritus","Necromass"))
layout.matrix.1<-matrix(
  nrow=length(V(redl)),  # Rows equal to the number of vertices
  ncol=2
)

#
# Calc incoherence
#
q <- calc_incoherence(redl,troph.net2)
websTbl$Q[3] <- q$Q
websTbl$rQ[3] <- q$rQ  # ratio of Q/eQ expected coherence under null -  Significan coherence rQ< 1, Significant incoherence rQ>1
websTbl$mTI[3] <- q$mTI # mean trophic level 
websTbl$rTI[3] <- q$rTI   # ratio of mTI/eTI expected under null 

# 
# Add colors to nodes 
#
require(RColorBrewer)

colTL <-as.numeric(cut(troph.net2$TL,11))
colnet <- brewer.pal(11,"RdYlGn")
V(redl)$color <- colnet[12-colTL]

#
# Plot modules
#
layout.matrix.1[,2]<-jitter(troph.net2$TL,0.4) # y-axis value based on trophic level
layout.matrix.1[,1]<-jitter(modulos$membership,1) # randomly assign along x-axis

png("Figures/MetaFoodWeb.png",width=6,height=6,units="in",res=600)
par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0))

plot(redl, vertex.color=vertex_attr(redl)$cor,vertex.label=NA,
     vertex.size=log(3*igraph::degree(redl)),
     edge.width=.3,edge.arrow.size=.4, 
     edge.color="grey50",
     edge.curved=0.3, layout=layout.matrix.1)

dev.off()

save.image()

#
# Calculate z-score of modularity
#
websTbl <- websTbl %>% mutate(zMO= (Modularity- rndMO)/(MOhigh-MOlow)*2, zGR=(Groups-rndGR)/(GRhigh-GRlow)*2)


require(pander)
panderOptions('table.split.table',Inf)
panderOptions('table.style', 'multiline')

pandoc.table(t(websTbl %>% dplyr::select(Network,Size,Links,Connectance,PathLength,Clustering,Modularity,Groups,SWness,SWnessCI,zMO,zGR,Q,rQ,mTI,rTI) %>% mutate_if(is.numeric, round, digits=4)))


```

# Analysis of motif - Local

```{r motifAnalysisLocal, eval=T,echo=F,message=T,warning=T}

source("R/network_fun.r")

require(igraph)
require(dplyr)
require(stringr)

#
# Read data and trim species names to avoid duplicates 
#
dtot <- read.delim("Data/Foodwebs.dat", quote="",stringsAsFactors = F)
dtot <- dtot %>% mutate(Predator_name=str_trim(Predator_name), Prey_name=str_trim(Prey_name))

#
# Select local food web - Potter Cove
#
dtot1 <- as.matrix(dtot %>% filter(Network=="Local") %>% dplyr::select(Prey_name,Predator_name))
redl <- graph_from_edgelist(dtot1, directed  = T)

#
# Make short names 
#
require(vegan)
spnames <- make.cepnames(V(redl)$name)
#write.csv(V(redl)$name,"Local.csv")

# Test if there are duplicated species
#
V(redl)$name[grep(".1",spnames)]

#
# Motif
#
mot <- triad_census(redl)

mot[4] # Exploitative competition
mot[5] # Apparent competition
mot[6] # Tri-trophic chain
mot[9] # Omnivory

FreqMotif <- data.frame(Network="Local",t(mot))

set.seed(123)
motif <- calc_motif_random(redl)
motif <- motif %>% mutate(Network="Local")

save.image()
```

# Analysis of motif - Regional

```{r motifAnalysisRegional, eval=T,echo=F,message=T,warning=T}

source("R/network_fun.r")

require(igraph)
require(dplyr)
require(stringr)

#
# Read data and trim species names to avoid duplicates 
#
dtot <- read.delim("Data/Foodwebs.dat", quote="",stringsAsFactors = F)
dtot <- dtot %>% mutate(Predator_name=str_trim(Predator_name), Prey_name=str_trim(Prey_name))

#
# Select food web 
#
dtot1 <- as.matrix(dtot %>% filter(Network=="Regional") %>% dplyr::select(Prey_name,Predator_name))
redl <- graph_from_edgelist(dtot1, directed  = T)
redl <- simplify(redl)

#
# Make short names 
#
require(vegan)
spnames <- make.cepnames(V(redl)$name)
#write.csv(V(redl)$name,"Regional.csv")

# Test if there are duplicated species
#
V(redl)$name[grep(".1",spnames)]
dup <- str_sub(spnames[grep(".1",spnames)], start = 1, end = -3)
V(redl)$name[str_detect(spnames,dup[1])]
V(redl)$name[str_detect(spnames,dup[2])]
V(redl)$name[str_detect(spnames,dup[3])]

V(redl)$name[which_loop(redl)]


#
# Motif
#
mot <- triad_census(redl)
mot[4] # Exploitative competition
mot[5] # Apparent competition
mot[6] # Tri-trophic chain
mot[9] # Omnivory


FreqMotif <- rbind(FreqMotif,data.frame(Network="Regional",t(mot)))

mot[10] # Loop 

set.seed(123)
motif <- bind_rows(motif, calc_motif_random(redl) %>% mutate(Network="Regional"))

save.image()
```


# Motif Analysis - MetaWEB!

```{r MotifAnalysisMetaWeb, eval=T,echo=F,message=T,warning=T}

source("R/network_fun.r")

require(igraph)
require(dplyr)
require(stringr)

#
# Read data and trim species names to avoid duplicates 
#
dtot <- read.delim("Data/Foodwebs.dat", quote="",stringsAsFactors = F)
dtot <- dtot %>% mutate(Predator_name=str_trim(Predator_name), Prey_name=str_trim(Prey_name))

#
# Select food web 
#
dtot1 <- as.matrix(dtot %>% filter(Network=="Meta") %>% dplyr::select(Prey_name,Predator_name))
redl <- graph_from_edgelist(dtot1, directed  = T)

# Select only a connected subgraph graph 
V(redl)$comp <- components(redl)$membership
redm <- induced_subgraph(redl,V(redl)$comp==1)

# Unconnected components 
redd <- induced_subgraph(redl,V(redl)$comp==2)

# Delete cannibalistic 
redl <- simplify(redm)

#
# Make short names 
#
require(vegan)
spnames <- make.cepnames(V(redl)$name)
#write.csv(V(redl)$name,"Meta.csv")


# Test if there are duplicated species
#
V(redl)$name[grep(".1",spnames)]
dup <- str_sub(spnames[grep(".1",spnames)], start = 1, end = -3)
for( i in 1:length(dup)){
  print(V(redl)$name[str_detect(spnames,dup[i])])
}

V(redl)$name[which_loop(redl)]


#
# Motif
#
mot <- triad_census(redl)
mot[4] # Exploitative competition
mot[5] # Apparent competition
mot[6] # Tri-trophic chain
mot[9] # Omnivory

FreqMotif <- rbind(FreqMotif,data.frame(Network="Meta",t(mot)))

mot[10] # Loop 

set.seed(123)
motif <- bind_rows(motif, calc_motif_random(redl) %>% mutate(Network="Meta"))

save.image()

require(pander)
panderOptions('table.split.table',Inf)
panderOptions('table.style', 'multiline')

motif <- motif %>% dplyr::select(Network, 1:length(names(motif)))

pandoc.table(t(motif %>% mutate_if(is.numeric, round, digits=4)))

```

# Analisis of motif frequency change across networks

Pag 616 The R book

```{r MotifAnalysisMetaWeb, eval=T,echo=F,message=T,warning=T}
require(dplyr)
#
# Build a dataframe with the relevant motifs
# 
pFM<- FreqMotif %>% group_by(Network) %>% dplyr::select(X4:X6,X9) %>% rename(EC=X4,AC=X5,TT=X6,OM=X9) %>% mutate(Tot=sum(EC,AC,TT,OM)) %>% ungroup()

require(tidyr)

pFM1 <- pFM %>% mutate(EC=EC/Tot,AC=AC/Tot,TT=TT/Tot, OM=OM/Tot) %>% dplyr::select(Network:OM) %>%gather(motif,count,EC:OM)
require(ggplot2)
ggplot(pFM1,aes(x=Network,y=count,fill=motif)) + geom_bar(stat="identity") + 
  scale_fill_brewer(palette = "RdYlGn", breaks=c("EC","AC","TT","OM"), name="", labels=c("Exploitative\ncompetition", "Apparent\ncompetition", "Tri-trophic\nchain","Omnivory")) + 
  xlab("") + ylab("Proportion") + theme_bw() + theme(legend.position="bottom")
ggsave("Figures/MotifProportionByNetwork.png",width=6,height=6,units="in",dpi=600)

#
# Test it using poisson glm (only the interaction counts )
#
pFM1 <- pFM %>%  dplyr::select(Network:OM) %>%gather(motif,count,EC:OM)

model1 <- glm(count~Network*motif,poisson, data=pFM1)
summary(model1)
model2 <- glm(count~Network+motif,poisson, data=pFM1)

anova(model1,model2,test="Chi")

#
# Pearson Chi-squared independence 
#

x <- FreqMotif %>% dplyr::select(X4:X6,X9) %>% rename(EC=X4,AC=X5,TT=X6,OM=X9)
x <- as.matrix(x)
rownames(x) <- FreqMotif$Network
require(RColorBrewer)
colnet <- brewer.pal(11,"RdYlGn")[c(1,11)]
png("Figures/NetworkByMotifFreq.png",width=6,height=6,units="in",res=600)
par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(2, 2, 0, 2))
colnames(x) <- c("Exploitative\ncompetition", "Apparent\ncompetition", "Tri-trophic\nchain","Omnivory")
assocplot(t(x),col=colnet)
dev.off()
#require(vcd)
#assoc(x, main = "Relation Network and motif", shade = TRUE)

chisq.test(x)
spineplot(x)
```
 
# Topological Roles


@Kortsch2015

The role is described by two parameters: (i) the standardized within-module degree z and (ii) the among-module
connectivity participation coefficient PC. The z-score reflects how well a species is connected to other species inside the module relative to other species within its own module. The PC parameter estimates the distribution of a species’ connections across the modules.


```{r topologicalRoles, eval=T,echo=F,message=T,warning=T}

source("R/network_fun.r")

require(igraph)
require(dplyr)
require(stringr)

#
# Read data and trim species names to avoid duplicates 
#
dtot <- read.delim("Data/Foodwebs.dat", quote="",stringsAsFactors = F)
dtot <- dtot %>% mutate(Predator_name=str_trim(Predator_name), Prey_name=str_trim(Prey_name))

#
# Select local food web 
#
dtot1 <- as.matrix(dtot %>% filter(Network=="Local") %>% dplyr::select(Prey_name,Predator_name))
redl <- graph_from_edgelist(dtot1, directed  = T)

#

tR <- calc_topological_roles(redl)
topoRoles <- tR %>% mutate(Network="Local")

png("Figures/TopoRoles_Local.png",width=6,height=6,units="in",res=600)
par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0))

# Initialize hub_conn
hub_conn <- data.frame()

# Plot and clasify topological roles
hub_conn <- bind_rows(hub_conn, plot_topological_roles(filter(topoRoles,Network=="Local"),redl,mod_by_red[[1]]) %>% mutate(Network="Local"))

dev.off()

save.image()

# Check if 100 simulations are the same as 1000
#
tR1 <- calc_topological_roles(redl,100)
tR2 <- topoRoles %>% filter(Network=="Local") 
require(kSamples)
ad.test(list(tR1$among_module_conn,tR2$among_module_conn),method="simulated",nsim=1000)
ad.test(list(tR1$within_module_degree,tR2$within_module_degree),method="simulated",nsim=1000)
# No difference with 100 or 1000 simulations

require(ggplot2)
tR3 <- tR1 %>% mutate(nsim=100) %>% bind_rows(tR2 %>% mutate(nsim=1000)) %>% mutate(nsim=as.factor(nsim))
ggplot(tR3, aes(within_module_degree,fill=nsim)) + geom_density(alpha=.5)
ggplot(tR3, aes(among_module_conn,fill=nsim)) + geom_density(alpha=.5)

rm(tR1,tR2,tR3)

#
# Select regional food web 
#
dtot1 <- as.matrix(dtot %>% filter(Network=="Regional") %>% dplyr::select(Prey_name,Predator_name))
redl <- graph_from_edgelist(dtot1, directed  = T)
redl <- simplify(redl)

#

tR <- calc_topological_roles(redl,100)
topoRoles <- bind_rows(topoRoles, tR %>% mutate(Network="Regional"))

png("Figures/TopoRoles_Regional.png",width=6,height=6,units="in",res=600)
par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0))
hub_conn <- bind_rows(hub_conn,plot_topological_roles(filter(topoRoles,Network=="Regional"),redl,mod_by_red[[2]]) %>% mutate(Network="Regional"))

dev.off()

#
# Select meta food web 
#
dtot1 <- as.matrix(dtot %>% filter(Network=="Meta") %>% dplyr::select(Prey_name,Predator_name))
redl <- graph_from_edgelist(dtot1, directed  = T)
redl <- simplify(redl)

#
rm(tR,tR1,tR2)

#
tR1 <- bind_rows(tR1, calc_topological_roles(redl,10))
saveRDS(tR1,"TopoRoles_Meta.rds")
tR2 <-   tR1 %>% group_by(node) %>% summarize(wtmLowCI=quantile(within_module_degree,0.005,na.rm=TRUE),
                                        wtmHiCI=quantile(within_module_degree,0.995,na.rm=TRUE),
                                        amcLowCI=quantile(among_module_conn,0.005,na.rm=TRUE),
                                        amcHiCI=quantile(among_module_conn,0.995,na.rm=TRUE),
                                        within_module_degree=mean(within_module_degree,na.rm=TRUE),
                                        among_module_conn=mean(among_module_conn,na.rm=TRUE))

#
# 
# There are Differences between 10 and 20 simulations
#  tR  = 40 
#  tR2 = 50
#  tR1 = data.frame with added simulations

require(kSamples)
ad.test(list(tR2$among_module_conn,tR$among_module_conn),method="simulated",nsim=1000)
ad.test(list(tR2$within_module_degree,tR$within_module_degree),method="simulated",nsim=1000)

tR <- tR2

# At 50 sims there is no difference with 40
#
#                 AD   T.AD  asympt. P-value  sim. P-value
# version 1: 0.04612 -1.254                1             1
# version 2: 0.04160 -1.260                1             1
#
#              AD   T.AD  asympt. P-value  sim. P-value
# version 1: 2.08 1.4200          0.08299        0.0849
# version 2: 1.31 0.4092          0.22860        0.2307

topoRoles <- bind_rows(topoRoles, tR %>% mutate(Network="Meta"))

png("Figures/TopoRoles_Meta.png",width=6,height=6,units="in",res=600)
par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0))

hub_conn <- bind_rows(hub_conn,plot_topological_roles(filter(topoRoles,Network=="Meta"),redl,mod_by_red[[3]]) %>% mutate(Network="Meta"))
dev.off()

save.image()


names(hub_conn)

tbl <- table(hub_conn$Network,hub_conn$type)

tbl1 <- tbl[c(1,3,2),] 

chisq.test(tbl,simulate.p.value = TRUE, B=10000)

require(RColorBrewer)
colnet <- brewer.pal(11,"RdYlGn")[c(1,11)]
#png("Figures/NetworkByMotifFreq.png",width=6,height=6,units="in",res=600)
par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(2, 2, 0, 2))
colnames(tbl1) <- c("Hub\nconnectors", "Module\nConnectors", "Module\nHubs", "Module\nSpecialists")
assocplot(t(tbl1),col=colnet)

require(ggplot2)
require(scales)
df1 <- data.frame(tbl1)
names(df1) <- c("Network","Rol","count")
df1 <- filter(df1,count!=0)
#df1 <- df1 %>% group_by(Network) %>% mutate(total=sum(count),Freq=count/total) 
g2 <- ggplot(df1,aes(x=Network,y=count,fill=Rol)) + geom_bar(stat="identity",position=position_dodge()) + 
  scale_fill_brewer(palette = "RdYlGn",name="Topological\nRol") + scale_y_continuous(trans=log1p_trans(),breaks=c(1,10,100,1000)) +
  xlab("") + ylab("") + theme_bw() #+ theme(legend.position="bottom") 
ggsave("Figures/TopoRolesProportionByNetwork.png",width=6,height=6,units="in",dpi=600)

# Combine g1 & g2 

require(tidyr)

names(motif)
pFM1 <- motif %>% dplyr::select(Network,zEC:zOM) %>%gather(motif,value,zEC:zOM)


g1 <- ggplot(pFM1,aes(x=Network,y=value,fill=motif)) + geom_bar(stat="identity",position=position_dodge()) + 
  scale_fill_brewer(palette = "RdYlGn",breaks=c("zEC","zAC","zTT","zOM"),name="Motif\nZ-score",   labels=c("Exploitative\ncompetition", "Apparent\ncompetition", "Tri-trophic\nchain","Omnivory")) + 
  xlab("") + ylab("") + theme_bw() + scale_x_discrete(limits=c("Local","Regional","Meta")) #+ theme(legend.position="bottom")

require(cowplot)
plot_grid(g1,g2,labels = c("A","B"),align = "h")

ggsave("Figures/Motif_TopoRoles_ByNetwork.png",width=8,height=5,units="in",dpi=600)



```

# Integrated plot of topological roles, trophic level and modularity

```{r plotTopoRolesTLmod, eval=T,echo=F,message=T,warning=T}

# Data frame hub_conn have the topological roles of species by network

# mod_by_red have the modules

# 
# Local 
#

png("Figures/AllTopoRoles_TL_MOD.png",width=8,height=8,units="in",res=600)
par(mfcol=c(2,2), mar=c(1,1.2,0.5,0.5), oma=c(2,2,2,0))
#par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(.5, 3, .5, 0.5))
plotTopoRolesByTLByMod(dtot,"Local",c("Fresh detritus","Aged detritus","Necromass"),mod_by_red[[1]],hub_conn)
mtext("A", side = 3, adj = 0.05, line=1 ,cex=1.2)
#dev.off()

#
# Metaweb
#
#png("Figures/MetawebTopoRoles_TL_MOD.png",width=6,height=6,units="in",res=600)
#par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(.5, 3, .5, 0.5))
plotTopoRolesByTLByMod(dtot,"Meta",c("Detritus","Necromass"),mod_by_red[[3]],hub_conn)
mtext("C", side = 3, adj = 0.05, line = -1,cex=1.2)


#
# Regional 
#
#png("Figures/RegionalTopoRoles_TL_MOD.png",width=6,height=6,units="in",res=600)
#par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(.5, 3, .5, 0.5))
plotTopoRolesByTLByMod(dtot,"Regional",c("Detritus","Necromass"),mod_by_red[[2]],hub_conn)
mtext("B", side = 3, adj = 0.05, line=1,cex=1.2)
#dev.off()


require(RColorBrewer)
colnet <- brewer.pal(4,"RdYlGn")

#par( mar=c(1,1,0.5,0.5), oma=c(2,2,2,1))


plot(1, type = "n", axes=FALSE, xlab="", ylab="")
legend(x = "center",
        legend = c("Hub connectors", "Module Connectors", "Module Hubs", "Module Specialists"), 
        col=colnet,pch=19, cex=1.2)
mtext("Modules", side = 1, outer=T, line=0.1,cex=1.2,font=2)
mtext("Trophic level", side = 2, outer=T, line=0.5,cex=1.2,font=2)


# mtext("B", side = 3, adj = 0.05, outer=F,line=1,cex=1.2)
# mtext("B", side = 3, adj = 1, line=1,cex=1.2)
# box("plot", lty="dotted", col="red")
# box("inner", lty="dotted", col="green")
# box("outer", lty="solid", col="green")

dev.off()

```


---
title: "From metawebs to regional and local"
author: "L.A.S."
output: html_document
editor_options: 
  chunk_output_type: console
---

## Setup

```{r setup, eval=T,echo=FALSE }
load(".RData")
oldcd <-getwd()
require(ggplot2)
require(igraph)
require(dplyr)
require(stringr)
require(devtools)
require(MetaWebAssemblyModels)
source("R/network_fun.r")

```

# Fitting metaWeb assembly models to Potter Cove   

```{r fitMetaWebPC, eval=F,echo=F,message=T,warning=T}

require(ggplot2)
require(igraph)
require(dplyr)
require(stringr)
require(devtools)
require(MetaWebAssemblyModels)
source("R/network_fun.r")
# load_all('MetaWebAssemblyModels')
# install_local('MetaWebAssemblyModels')
#sourceCpp("src/NetAssemblyFromMetaWeb.cpp")

#
# Read data and trim species names to avoid duplicates 
#
dtot <- read.delim("Data/Foodwebs.dat", quote="",stringsAsFactors = F)
dtot <- dtot %>% mutate(Predator_name=str_trim(Predator_name), Prey_name=str_trim(Prey_name))

#
# Select food web 
#
dtot1 <- as.matrix(dtot %>% filter(Network=="Meta") %>% dplyr::select(Prey_name,Predator_name))
redl <- graph_from_edgelist(dtot1, directed  = T)
# Delete cannibalistic 
redl <- simplify(redl)
sum(degree(redl,mode="in")==0)

A <- get.adjacency(redl,sparse=F)
dim(A)

#
# Testing if 500 time steps is enough to find equilibrium point
#
tf <- 2000
AA <- metaWebNetAssembly(A,0.05,1,0.2,tf)
plot_NetAssemblyModel(AA,400)
plot_NetAssemblyModel_eqw(AA,100)
tf <- 500
AA <- metaWebNetAssembly(A,0.05,1,0.2,tf)
plot_NetAssemblyModel_eqw(AA,100)



# Simulate a grid of parameters to select the best options
#
#

# Combine parameters
arguments <- expand.grid(m = seq(from=0.01,to=0.1,by=0.001), a = seq(from=0.01,to=0.1,by=0.001))
simMetaWebAssembly <- data.frame()
# repeat ten times
#arguments<- bind_rows(arguments,arguments,arguments,arguments,arguments,arguments,arguments,arguments,arguments,arguments)
tf <- 500
sim <- data.frame()
require(doParallel)
require(tictoc)
cn <-detectCores()
#  cl <- makeCluster(cn,outfile="foreach.log") # Logfile to debug 
cl <- makeCluster(cn)
registerDoParallel(cl)
nsim <- dim(arguments)[1]
tic()
sim <- foreach(i=1:nsim,.combine='rbind',.inorder=FALSE,.packages='MetaWebAssemblyModels') %dopar% 
{
  mm <- arguments[i,1]
  aa <- arguments[i,2]
  AA <- metaWebNetAssembly(A,mm,1,aa,tf)
  dfA <- data.frame(S=AA$S[200:tf],L=as.numeric(AA$L[200:tf]),T=c(200:tf))
  data.frame(m=mm,a=aa, S=mean(dfA$S),L=mean(dfA$L),C=mean(dfA$L)/(mean(dfA$S)*mean(dfA$S)))
}
toc()
stopCluster(cl)
simMetaWebAssembly <- bind_rows(simMetaWebAssembly,sim)
saveRDS(simMetaWebAssembly,"Data/simulations_metaWebAssembly.rds")
#simMetaWebAssembly <- readRDS("Data/simulations_metaWebAssembly.rds")

# To select the parameters I lowered the tolerance until there is only one value or few values
#
# Potter Cove
#

tol <- .2
simMetaWebAssembly %>% group_by(m,a) %>% summarize(S=mean(S),L=mean(L),C=mean(C)) %>% mutate(alpha=m/a) %>% filter(L>309*(1-tol),L<309*(1+tol),S>91*(1-tol),S<91*(1+tol)) %>% arrange(desc(L))
# Simulations
#       m     a        S        L         C    alpha
# 4 0.019  0.08 108.0955 249.9427 0.02139875 0.2375
# 7 0.023 0.096 109.0323 247.8472 0.02086496 0.2395833
# 8 0.015 0.064 108.8941 251.1877 0.02111088 0.234375
# 9 0.015 0.064 108.7829 250.4179 0.02109662 0.234375

# Weddell Sea
#
tol <- .13
simMetaWebAssembly %>% group_by(m,a) %>% summarize(S=mean(S),L=mean(L),C=mean(C)) %>% mutate(alpha=m/a) %>% filter(L>1908*(1-tol),L<1908*(1+tol), S>436*(1-tol),S<437*(1+tol)) %>% arrange(S)

# Simulations
#       m     a        S        L         C    alpha
# 4 0.022 0.021 385.7151 2143.468 0.0144348  1.047619
# 7 0.044 0.041 381.4585 2150.424 0.01477366 1.073171
# 8 0.014 0.014 380.1873 2101.99 0.01457585     1
# 9 0.014 0.014 380.323 2106.511 0.01459287     1

AA <- metaWebNetAssembly(A,0.019,1,0.08,tf)
dfA <- data.frame(S=AA$S[200:tf],L=as.numeric(AA$L[200:tf]),T=c(200:tf))
c(mean(dfA$S),mean(dfA$L),mean(dfA$L)/(mean(dfA$S)*mean(dfA$S)))

plot_NetAssemblyModel_eqw(AA,100)
plot_NetAssemblyModel(AA,300)

AA <- metaWebNetAssembly(A,0.022,1,0.021,tf)
dfA <- data.frame(S=AA$S[200:tf],L=as.numeric(AA$L[200:tf]),T=c(200:tf))
c(mean(dfA$S),mean(dfA$L),mean(dfA$L)/(mean(dfA$S)*mean(dfA$S)))

plot_NetAssemblyModel_eqw(AA,100)
plot_NetAssemblyModel(AA,300)

```



# Local web (Potter Cove) compared to  metaWeb assembly model 

```{r mdlMetaWebAssembly, eval=T,echo=F,message=T,warning=T}


#sourceCpp("src/NetAssemblyFromMetaWeb.cpp")

#
# Read data and trim species names to avoid duplicates 
#
dtot <- read.delim("Data/Foodwebs.dat", quote="",stringsAsFactors = F)
dtot <- dtot %>% mutate(Predator_name=str_trim(Predator_name), Prey_name=str_trim(Prey_name))

#
# Select meta web 
#
dtot1 <- as.matrix(dtot %>% filter(Network=="Meta") %>% dplyr::select(Prey_name,Predator_name))
redl <- graph_from_edgelist(dtot1, directed  = T)
# Delete cannibalistic 
redl <- simplify(redl)
sum(degree(redl,mode="in")==0)

A <- get.adjacency(redl,sparse=F)
dim(A)                             

#
# Select Local food web 
# 

dtot1 <- as.matrix(dtot %>% filter(Network=="Local") %>% dplyr::select(Prey_name,Predator_name))
redl <- graph_from_edgelist(dtot1, directed  = T)

#
# Calculate Trophic Position
#
require(NetIndices)
TL <-TrophInd(get.adjacency(redl,sparse=F),Dead=c("Fresh detritus","Aged detritus","Necromass"))

#
# Compare modularity 
#
require(tictoc)
m <- 0.015
a <- 0.064
tic()
tblMdlWeb <- calc_modularity_metaWebAssembly(redl, A, m,a,1000,TL)
toc()

tblMdlWeb <- tblMdlWeb %>% mutate(Network="Local") %>% inner_join(dplyr::select(websTbl,Size:Modularity), by="Network")

#
# Calculate z-score of modularity
#
tblMdlWeb <- tblMdlWeb %>% mutate(zMO= (Modularity- mdlMO)/(MOhigh-MOlow)*2, zGR=(Groups-mdlGR)/(GRhigh-GRlow)*2)

#websAssemblyModel <- dplyr::select(tblMdlWeb,Network:Modularity,mdlCC:zTI,zMO:zGR)
websAssemblyModel <- bind_rows(websAssemblyModel, dplyr::select(tblMdlWeb,Network:Modularity,mdlCC:zTI,zMO:zGR))

save.image()

```



# Regional web (Weddell) compared to  metaWeb assembly model 

```{r regionalMetaWebAssembly, eval=F,echo=F,message=T,warning=T}

#
# Select "Regional" food web 
#
dtot1 <- as.matrix(dtot %>% filter(Network=="Regional") %>% dplyr::select(Prey_name,Predator_name))
redl <- graph_from_edgelist(dtot1, directed  = T)
redl <- simplify(redl)


require(NetIndices)
TL<-TrophInd(get.adjacency(redl,sparse=F),Dead=c("Detritus","Necromass"))

#
# Compare modularity 
#
require(tictoc)
m <- 0.014
a <- 0.014
tic()
tblMdlWeb <- calc_modularity_metaWebAssembly(redl, A, m,a,1000,TL)
toc()

tblMdlWeb <- tblMdlWeb %>% mutate(Network="Regional") %>% inner_join(dplyr::select(websTbl,Size:Modularity), by="Network")

#
# Calculate z-score of modularity
#
tblMdlWeb <- tblMdlWeb %>% mutate(zMO= (Modularity- mdlMO)/(MOhigh-MOlow)*2, zGR=(Groups-mdlGR)/(GRhigh-GRlow)*2)

websAssemblyModel <- bind_rows(websAssemblyModel, dplyr::select(tblMdlWeb,Network:Modularity,mdlCC:zTI,zMO:zGR))

save.image()

```


